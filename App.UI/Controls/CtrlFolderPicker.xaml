<?xml version="1.0" encoding="utf-8"?>
<UserControl x:Class="JpegViewer.App.UI.Controls.CtrlFolderPicker"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:support="using:JpegViewer.App.UI.Support"
             xmlns:i="using:Microsoft.Xaml.Interactivity"
             mc:Ignorable="d"
             x:Name="FolderPicker">

    <!-- Resource definitions and overrides for Folder picker control -->
    <UserControl.Resources>
        <SolidColorBrush x:Key="TreeViewItemSelectionIndicatorForeground" Color="Red"/>
        <SolidColorBrush x:Key="TreeViewItemSelectionIndicatorForegroundPointerOver" Color="Red"/>
        <SolidColorBrush x:Key="TreeViewItemSelectionIndicatorForegroundPressed" Color="Red"/>
        <SolidColorBrush x:Key="TreeViewItemForeground" Color="#9EA0A2"/>
        <SolidColorBrush x:Key="TreeViewItemForegroundSelected" Color="#9EA0A2"/>
        <SolidColorBrush x:Key="TreeViewItemForegroundPointerOver" Color="#9EA0A2"/>
        <SolidColorBrush x:Key="TreeViewItemForegroundSelectedPointerOver" Color="#9EA0A2"/>
        <SolidColorBrush x:Key="TreeViewItemForegroundPressed" Color="#9EA0A2"/>
        <SolidColorBrush x:Key="TreeViewItemForegroundSelectedPressed" Color="#9EA0A2"/>
        <support:EnumToGlyphConverter x:Key="EnumToGlyphConverter"/>
        
        <!-- Item template for folder selection tree -->
        <DataTemplate x:Key="FolderPickerItemTemplate">
            <TreeViewItem ItemsSource="{Binding Childs}"
                          AutomationProperties.Name="{Binding Name}"
                          IsExpanded="{Binding IsExpanded, Mode=TwoWay}"
                          IsSelected="{Binding IsSelected, Mode=TwoWay}"
                          PointerEntered="TreeViewItem_PointerEntered"
                          PointerExited="TreeViewItem_PointerExited">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <FontIcon Glyph="{Binding ItemIcon, Converter={StaticResource EnumToGlyphConverter}}" HorizontalAlignment="Left"/>
                    <TextBlock Grid.Column="1" Margin="4 2 20 0" Text="{Binding Name}">
                        <i:Interaction.Behaviors>
                            <i:DataTriggerBehavior Binding="{Binding IsSelected}" Value="True">
                                <i:ChangePropertyAction PropertyName="Foreground" Value="Red"/>
                            </i:DataTriggerBehavior>
                            <i:DataTriggerBehavior Binding="{Binding IsSelected}" Value="False">
                                <i:ChangePropertyAction PropertyName="Foreground" Value="#F2F3F3"/>
                            </i:DataTriggerBehavior>
                        </i:Interaction.Behaviors>
                    </TextBlock>
                </Grid>
            </TreeViewItem>
        </DataTemplate>
    </UserControl.Resources>

    <!-- Folder picker's root grid -->
    <Grid x:Name="root" Background="{StaticResource colorControlBackground}" MinWidth="250">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>

        <!-- Title -->
        <TextBlock Margin="16 2 0 8" Text="Select a folder:" FontSize="16" HorizontalAlignment="Left"/>        
        
        <!-- Folder selection tree with top border-->
        <Border Grid.Row="1" VerticalAlignment="Top"/>
        <TreeView x:Name="treeView" Grid.Row="1"
                  ItemsSource="{Binding Folders}"
                  ItemTemplate="{StaticResource FolderPickerItemTemplate}"
                  SelectedItem="{Binding SelectedItem, Mode=TwoWay}"
                  CanDragItems="False"
                  CanDrag="False"
                  AllowDrop="False"/>
        
        <!-- Refresh button on the bottom left -->
        <FontIcon Grid.Row="2"
                  HorizontalAlignment="Left"
                  Margin="16 0 0 0"
                  Glyph="&#xe72c;"
                  FontSize="20"
                  FontWeight="Bold"
                  PointerEntered="FontIcon_PointerEntered"
                  PointerExited="FontIcon_PointerExited"
                  PointerPressed="FontIcon_PointerPressed"
                  PointerReleased="FontIcon_PointerReleased">
            <i:Interaction.Behaviors>
                <i:EventTriggerBehavior EventName="PointerReleased">
                    <i:InvokeCommandAction Command="{Binding RefreshPressedCommand}"/>
                </i:EventTriggerBehavior>
            </i:Interaction.Behaviors>
        </FontIcon>

        <!-- OK and Cancel buttons on the bottom right-->
        <StackPanel Grid.Row="2" Margin="0 16 16 16" Orientation="Horizontal" HorizontalAlignment="Right">
            <FontIcon Glyph="&#xf78c;"
                      FontSize="24"
                      FontWeight="Bold"
                      PointerEntered="FontIcon_PointerEntered"
                      PointerExited="FontIcon_PointerExited"
                      PointerPressed="FontIcon_PointerPressed"
                      PointerReleased="FontIcon_PointerReleased">
                <i:Interaction.Behaviors>
                    <i:EventTriggerBehavior EventName="PointerReleased">
                        <i:InvokeCommandAction Command="{Binding OkPressedCommand}"/>
                        <i:ChangePropertyAction TargetObject="{Binding ElementName=FolderPicker, Path=DataContext}" PropertyName="CurrentFolder" Value="{Binding SelectedItem.FullPath}"/>
                        <i:ChangePropertyAction TargetObject="{Binding ElementName=FolderPicker, Path=DataContext}" PropertyName="IsFolderPickerVisible" Value="False"/>
                    </i:EventTriggerBehavior>
                </i:Interaction.Behaviors>
            </FontIcon>
            <FontIcon Margin="16 0 0 0"
                      Glyph="&#xf78a;"
                      FontSize="18"
                      FontWeight="Bold"
                      PointerEntered="FontIcon_PointerEntered"
                      PointerExited="FontIcon_PointerExited"
                      PointerPressed="FontIcon_PointerPressed"
                      PointerReleased="FontIcon_PointerReleased">
                <i:Interaction.Behaviors>
                    <i:EventTriggerBehavior EventName="PointerReleased">
                        <i:InvokeCommandAction Command="{Binding CancelPressedCommand}"/>
                        <i:ChangePropertyAction TargetObject="{Binding ElementName=FolderPicker, Path=DataContext}" PropertyName="IsFolderPickerVisible" Value="False"/>
                    </i:EventTriggerBehavior>
                </i:Interaction.Behaviors>
            </FontIcon>
        </StackPanel>
        
        <!-- Right side border of the control -->
        <Border Grid.Column="1" Grid.RowSpan="3"/>

        <!-- Events and data triggers of our root grid -->
        <i:Interaction.Behaviors>
            <i:EventTriggerBehavior EventName="Loaded">
                <i:InvokeCommandAction Command="{Binding LoadedCommand}"/>
            </i:EventTriggerBehavior>
        </i:Interaction.Behaviors>
    </Grid>

    <!-- Event and data triggers of Folder picker control -->
    <i:Interaction.Behaviors>
        <i:DataTriggerBehavior Binding="{Binding IsFolderPickerVisible}" Value="False">
            <i:ChangePropertyAction PropertyName="Visibility" Value="Collapsed"/>
        </i:DataTriggerBehavior>
        <i:DataTriggerBehavior Binding="{Binding IsFolderPickerVisible}" Value="True">
            <i:ChangePropertyAction PropertyName="Visibility" Value="Visible"/>
        </i:DataTriggerBehavior>
    </i:Interaction.Behaviors>
</UserControl>
